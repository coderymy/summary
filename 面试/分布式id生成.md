# 2024总结

实现方案：

1. UUID，有点简单、问题是长度不可控，易重复
2. 雪花算法，基于机器ID+时间戳等生成。递增、需要单独部署
3. leaf+segement，基于数据库的业务标识和步长，然后每台机器获取一个号段之后在本机生成，id增加为有序。



学习自：[美团团队](https://tech.meituan.com/2017/04/21/mt-leaf.html)

# 方案实现

## UUID

优缺点：

> 优点：本地生成，效率高
>
> 缺点：
>
> + 不适合所有场景
> + 32位太长
> + 不满足逐渐逐步递增的方案
> + 且容易泄露MAC地址





## 雪花算法

实现方式

64-bit，分别使用41位时间戳、10位主机ID（idc划分也可加入进去）、12位自增序列号



优缺点：

> 优点：
>
> + 逐步递增（时间戳在高位，自增序列在低位）
> + 效率高，单独部署
> + 根据业务来分配bit位（自增序列位）
>
> 缺点：
>
> + 依赖机器时间，如果时间回拨会导致重复 发号



## 数据库实现

基于以下语句

```sql
begin;
REPLACE INTO Tickets64 (stub) VALUES ('a');
SELECT LAST_INSERT_ID();
commit;
```

![](https://awps-assets.meituan.net/mit-x/blog-images-bundle-2017/8a4de8e8.png)

优缺点：

> 优点：
>
> + 单调递增
> + 可以各种业务一起使用
>
> 缺点：
>
> + 依赖DB，DB出现问题会导致生成问题重复等
> + 限制单台数据库读写效率

数据库方式优化

优化点1：单点故障。多台mysql，然后设置歩长（每次自增的数量），比如每步都是2。mysql1从135进行，mysql2从2开始246

## 最终结果方案Leaf

### Leaf-segment

在数据库的方案上优化

1、每次都是批量的获取id，然后保存在本地进行分配

2、表结构增加biz_tag来标识不同的业务

```sql
+-------------+--------------+------+-----+-------------------+-----------------------------+
| Field       | Type         | Null | Key | Default           | Extra                       |
+-------------+--------------+------+-----+-------------------+-----------------------------+
| biz_tag     | varchar(128) | NO   | PRI |                   |                             |
| max_id      | bigint(20)   | NO   |     | 1                 |                             |
| step        | int(11)      | NO   |     | NULL              |                             |
| desc        | varchar(256) | YES  |     | NULL              |                             |
| update_time | timestamp    | NO   |     | CURRENT_TIMESTAMP | on update CURRENT_TIMESTAMP |
+-------------+--------------+------+-----+-------------------+-----------------------------+
```

biz_tag用来区分业务，max_id表示该biz_tag目前所被分配的ID号段的最大值，step表示每次分配的号段长度。

![](https://awps-assets.meituan.net/mit-x/blog-images-bundle-2017/5e4ff128.png)





# 考虫网id分配实现方式

1、加锁：获取数据库步数的时候加分布式锁，获取id的时候加synchronize关键字

2、多个业务，多个tag。然后支付id和订单id上限较高。其余上限低

3、顺序递增的，订单号虽然是顺序递增容易让外人获取订单信息。但是对于外部访问的接口，都有uid和订单号关联关系的限制。只有对应的uid才能访问到对应的订单号信息



